name: ðŸš€ Performance Report & GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  performance-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ðŸ§ª Run Tests
      run: npm test
      
    - name: ðŸ“Š Generate Performance Report
      run: |
        mkdir -p docs
        node --import tsx scripts/generate-performance-report.js
        
    - name: ðŸ“ˆ Update Historical Data
      run: node scripts/update-historical-data.js
        
    - name: ðŸŽ¨ Generate Performance Dashboard
      run: node scripts/generate-dashboard.js
      
    - name: ðŸ“ˆ Create Performance Badges  
      run: |
        echo "Skipping badge creation for now..."
        mkdir -p docs/badges
        
    - name: ðŸ“„ Copy Report Files
      run: |
        cp performance-report.json docs/
        cp badges.json docs/
        
        # Create a simple index.html that redirects to dashboard
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0; url=performance-dashboard.html">
            <title>Redirecting to Performance Dashboard...</title>
        </head>
        <body>
            <p>Redirecting to <a href="performance-dashboard.html">Performance Dashboard</a>...</p>
        </body>
        </html>
        EOF
        
    - name: ðŸ“‹ Create Performance Summary
      run: |
        echo "Creating simple performance summary..."
        echo "# Performance Report" > performance-summary.md
        echo "Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> performance-summary.md
        
    - name: ðŸ“¤ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        force_orphan: true
        
    - name: ðŸ’¬ Comment Performance Report
      if: github.event_name == 'pull_request'
      run: echo "Skipping PR comments for now..."
          
    - name: ðŸ“Š Upload Performance Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: |
          performance-report.json
          docs/performance-dashboard.html
          docs/badges/
        retention-days: 30