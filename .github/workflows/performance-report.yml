name: 🚀 Performance Report & GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  performance-report:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 📦 Install Dependencies
      run: npm ci
      
    - name: 🧪 Run Tests
      run: npm test
      
    - name: 🔍 Check Environment  
      run: |
        echo "OS: $(uname -a)"
        echo "CPU: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^ *//')"
        echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Platform: $(node -p 'process.platform')"
        echo "Arch: $(node -p 'process.arch')"
        echo "Node: $(node --version)"
      
    - name: 📊 Generate Performance Report
      run: |
        mkdir -p docs
        node --import tsx scripts/generate-performance-report.js
        
    - name: 📈 Update Historical Data
      run: node scripts/update-historical-data.js
        
    - name: 🎨 Generate Performance Dashboard
      run: node scripts/generate-dashboard.js
      
    - name: 📈 Create Performance Badges  
      run: |
        echo "Skipping badge creation for now..."
        mkdir -p docs/badges
        
    - name: 📄 Copy Report Files
      run: |
        cp performance-report.json docs/
        cp badges.json docs/
        
        # Create a simple index.html that redirects to dashboard
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0; url=performance-dashboard.html">
            <title>Redirecting to Performance Dashboard...</title>
        </head>
        <body>
            <p>Redirecting to <a href="performance-dashboard.html">Performance Dashboard</a>...</p>
        </body>
        </html>
        EOF
        
    - name: 📋 Create Performance Summary
      run: |
        echo "Creating simple performance summary..."
        echo "# Performance Report" > performance-summary.md
        echo "Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> performance-summary.md
        
    - name: 📤 Setup Pages
      uses: actions/configure-pages@v3
      
    - name: 📤 Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs
        
    - name: 📤 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'
        
    - name: 💬 Comment Performance Report
      if: github.event_name == 'pull_request'
      run: echo "Skipping PR comments for now..."
          
    - name: 📊 Upload Performance Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: |
          performance-report.json
          docs/performance-dashboard.html
          docs/badges/
        retention-days: 30